# 設定画面 / 初期設定ダイアログ仕様書

作成日: 2026-01-31

## 目的

本アプリで利用する各種設定情報を入力・管理するための画面およびダイアログ仕様を定義する。`設定画面` と `初期設定ダイアログ` は扱う設定内容・仕様は同一とし、UI と操作フローのみが異なる。

- 設定画面：通常利用時の設定変更用（セクション単位の編集）
- 初期設定ダイアログ：初回起動時のウィザード形式入力（ステップ方式）

（注）本仕様は SPA / タブ構成での実装を前提とし、ルーティング／URL 変更は行わない。

---

## 共通仕様（設定内容）

両 UI において以下の設定情報を扱う：

- TSV 取込み（フィーチャーデータ）
- ヘッダーマッピング（TSV ヘッダー → 内部項目）
- イテレーション情報（開始/終了/稼働日）
- メンバー情報（氏名 / 担当 / 計画ベロシティ）
- 初期設定 JSON のインポート / エクスポート

データ永続化:

- 設定は `settingsStore`（`zustand`）に保持する。永続化には `localStorage` を使用せず、設定の保存・移行は初期設定 JSON のインポート/エクスポートで行う。

---

## 初期設定ダイアログ仕様（ウィザード）

### 全体方針

- ステップ方式（ウィザード）で入力を進める。各ステップは完了条件を満たした場合のみ次へ進める。
- 入力途中の状態はダイアログ内で保持する。
- 完了時にダイアログを閉じ、設定を `settingsStore` に反映する。

### ステップ構成（詳細）

#### ステップ1：TSV 取込み

- フィーチャー TSV ファイルをアップロードする UI を提供。
- TSV パーサ（クライアント）でヘッダー抽出と基本バリデーションを行う（必須カラムの存在確認など）。
- バリデーション結果（成功/失敗行数・エラーサンプル）を表示。正常に読み込めた場合のみ次へ進める。

#### ステップ2：初期設定ファイルの有無確認（ヘッダーマッピング優先適用）

- ユーザーに「初期設定 JSON を持っているか」を問う（持っている / 持っていない のトグル）。

- 持っている場合
  - JSON ファイルをインポートしてバリデーションを実行する。
  - バリデーション成功 → 内部の `headerMapping` や `members`、`iterations` 等を一時的に適用し、内容確認画面を表示する。ユーザーが OK を押したら設定へ反映する。ヘッダーマッピングが提供されている場合は次のヘッダーマッピング画面で自動適用済みの状態で編集可能とする（必要に応じてヘッダーマッピング画面をスキップするオプションを表示してもよい）。
  - バリデーション失敗 → エラーを行単位／項目単位で表示し、修正またはスキップして次へ進む選択肢を提示する。

- 持っていない場合
  - 「次へ」ボタンでヘッダーマッピング画面へ進む。

#### ステップ3：ヘッダーマッピング

- TSV の各ヘッダーをアプリ内部項目にマッピングする画面を表示。
- 必須項目（`title`, `status`, `iteration` など）はすべてマッピングされていることを次へ進む条件とする。
- 自動マッピング機能：ステップ2でインポートされた `headerMapping` があれば事前に適用し、ユーザーは編集できる。

#### ステップ4：イテレーション情報の入力

- イテレーションは「テキストエリア」にタブ区切りの行で貼り付ける形式を基本とする（編集はテーブル形式で行うUIも用意する）。パーサは入力を行毎に解析し、内部では ISO 日付に正規化して扱う。

- 受け付ける日付フォーマット（例、どちらでも可）：
  - `YYYY-MM-DD`（例: 2026-06-30）
  - ローカル表記 `M月D日`（例: 6月30日）

- テキストエリア入力例（タブ区切り）：

```
開始日	終了日	稼働日
6月30日	7月11日	10
7月14日	7月25日	9
7月28日	8月8日	10
8月18日	8月29日	10
9月1日	9月12日	10
9月16日	9月26日	8
9月29日	10月10日	10
10月14日	10月24日	9
10月27日	11月7日	9
```

- バリデーション：開始日 < 終了日、稼働日数が正の整数であること。パーサは日付を正規化し、解析失敗行はエラー一覧で表示する（ユーザーは修正して再読み込み）。

#### ステップ5：対象イテレーション範囲の指定

- 開始イテレーション / 終了イテレーションをドロップダウンで選択する。既入力のイテレーションを選択肢として表示。

#### ステップ6：メンバー情報の入力

- 各メンバーについて氏名・担当（FE/BE/テスト）・計画ベロシティ（pt/日）を入力する。複数人登録可能。
- `plannedVelocity` の単位は `pt/day`（1日の目標ストーリーポイント）とし、小数を許容する（例: 2.5）。
- バリデーション：氏名は必須、計画ベロシティは 0 以上の数値。

#### ステップ7：初期設定エクスポート確認

- 現在の設定を JSON としてエクスポートするか確認する画面を表示。
- エクスポートする場合はダウンロード実行。エクスポートの有無にかかわらず「完了」操作でダイアログを閉じる。

### ウィザードの共通 UI 挙動

- ステップ遷移は「戻る/次へ」ボタンで行う（完了条件を満たすと次へ有効化）。
- 進行状況インジケータ（ステップ数表示）を上部に表示。
- キーボード操作：Enter で次へ（条件満たす場合）、Esc でキャンセル。

---

## 設定画面仕様（常設画面）

- 初期設定ダイアログと同一の設定項目を扱うが、UI は「閲覧モード」と「編集モード」を持つ（項目は同一）。
- 表示はカード／アコーディオン形式で行い、各セクションは以下の順序で上から表示する（優先度を明確にするため固定順とする）：
  1. プルリクを含めるか（`includePRinDone` のトグル）
  2. JSON を出力するボタン（エクスポート）
  3. メンバー情報（氏名／担当／計画ベロシティ）
  4. イテレーション情報（開始/終了/稼働日）
  5. ヘッダーマッピング（TSV ヘッダー → 内部項目）

- モードの振る舞い：
  - 閲覧モード：すべての入力は読み取り専用として表示される。`JSON 出力` ボタンは有効、`編集` ボタンで編集モードへ移行する。
  - 編集モード：フィールドが編集可能になり、編集は画面内のドラフト状態に適用される。ユーザーが `保存` を押下した際に入力をバリデーションし、成功したら `settingsStore` に反映する。永続化は初期設定 JSON のエクスポートで行い、`localStorage` は使用しない。`キャンセル` 操作でドラフトは破棄され、表示は保存済みの状態に戻る。`保存` ボタンはバリデーションが通るまで無効とする。

- 表示/編集の細則：
  - `includePRinDone` トグルは画面上部に常に表示し、すぐに切り替えできるようにする（閲覧モードでは現在値を表示）。
  - `JSON を出力` ボタンは常時表示し、エクスポートは現在の `settingsStore` の状態を元に行う。
  - メンバー / イテレーション / ヘッダーマッピングは各カード内で展開・折りたたみ可能とする。
  - 設定上書き時はユーザー確認ダイアログを表示し、上書き／マージの選択を行えるようにする（既存仕様に整合）。

- アクセシビリティ／操作性：
  - キーボード操作で `編集` → Tab/Enter による入力、Esc で編集キャンセルをサポートする。
  - 画面はスクリーンリーダー向けにラベルと aria 属性を設定する（詳細は実装時に決定）。

- その他：TSV 取込みや JSON インポートは画面下部または別カードで利用可能とし、上記表示順を崩さない。

---

## バリデーションとエラー処理

- ファイルインポート（TSV/JSON）はクライアント側でパースし、必須項目の有無とフォーマット（例: 日付は ISO）を検証する。
- 不整合がある場合は行単位でエラー表示し、ユーザーに対して「スキップ」「修正して再読み込み」「中止（ロールバック）」の選択肢を提示する。
  - 設定上書き時は常にユーザー確認ダイアログを表示する（上書き / マージの選択）。デフォルト選択は `上書き` とする。

---

## 永続化と同期

- 設定は `settingsStore`（`zustand`）に保持する。永続化は `localStorage` を使用せず、設定の永続化・移行は初期設定 JSON のインポート/エクスポートで行う。
- 起動時はインポート済みの初期設定 JSON を使用する。

---

## 機能一覧（要件）

- SR-001: TSV 取込みと行単位バリデーション
- SR-002: ヘッダーマッピングの保存／編集／自動適用
- SR-003: 初期設定 JSON のインポート（バリデーション）／エクスポート
- SR-004: イテレーション・メンバー情報の編集と検証
- SR-005: 設定の永続化（初期設定 JSON のインポート/エクスポート）とストア反映

---

## JSON スキーマ（出力例）

```json
{
  "members": [{ "name": "山田 太郎", "role": "FE", "plannedVelocity": 16 }],
  "iterations": [
    { "start": "2026-06-30", "end": "2026-07-11", "workingDays": 10 }
  ],
  "headerMapping": {
    "title": "課題名",
    "storyPoints": "SP",
    "status": "状態"
  },
  "settings": {
    "includePRinDone": false
  }
}
```

---

## JSON スキーマ（検証ルール）

- 必須フィールド
  - `members`, `iterations`, `headerMapping`, `settings` の存在を検証する。
- `members` の扱い
  - メンバーの重複は許容する（表示上は同名が並ぶ可能性があるため、実運用での扱いは PO 決定）。
  - `plannedVelocity` は `pt/day`（1日の目標ストーリーポイント）を表す数値であり、小数を許容する。
- `iterations` の扱い
  - 同一期間（開始/終了）が重複する場合は許容するが、UI 上は識別できるように `name` またはインデックスを付与することを推奨する。
- `headerMapping` の必須キー
  - 少なくとも `title`, `status`, `iteration` のマッピングが存在することを必須とする（`storyPoints` 等は任意だが、集計で必要な場合はバリデーションで警告する）。
  - 注記: TSV の `iteration` 列は内部のイテレーション番号（インデックス／数値）にマップされることを想定する。ヘッダーマッピング画面ではこの変換ルールを明示する。
- インポート時の挙動
  - インポート前にスキーマ検証を行い、エラーがある場合は行単位／項目単位で詳細を表示する。既存設定との競合はユーザー確認ダイアログで解決し、デフォルトは上書きとなる。

## 受け入れ条件（例）

- AC-SR-001: 初期設定ウィザードを完了すると、`settingsStore` に設定が反映され、TSV のインポート内容がアプリに表示される。
- AC-SR-002: JSON インポート時に必須フィールドが欠けている場合、明示的なエラーが表示され、ユーザーが対処方法を選べること。
- AC-SR-003: ユーザーが `エクスポート` を実行すると、現在設定が JSON ファイルとしてダウンロードされること。

---
